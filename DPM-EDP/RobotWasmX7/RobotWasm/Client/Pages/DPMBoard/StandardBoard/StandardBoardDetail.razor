@page "/DPMBoard/StandardBoard/StandardBoardDetail"

@using System.Text.Json
@using System.Text
@using RobotWasm.Shared.Data.ML.FileGo
@using RobotWasm.Shared.Data.ML.Shared
@using Blazorise

<style>

    div.gallery div{
        margin:5px;
        border:1px solid black;
        padding:5px;
        width:21%;
        float:left;
        text-align: center;
    }

    div.gallery div img{
        width:70%;
    }

    .title {
        font-size:medium;
        margin: 0.4rem 0 0.3rem 0;
        text-align:center;
    }

    /*listview card image*/

    .k-listview-content {
        display: block !important;
    }

    .footer-note {
        text-align: right;
        font-style: italic;
        font-size: 0.85em;
    }

    /*end listview card image*/

    .k-checkbox:checked, .k-checkbox.k-checked {
        border-color: #03a9f4;
        background-color: #03a9f4;
    }

    .k-button-solid-error, .k-button-solid-error:hover, .k-button-solid-error.k-hover {
        border-color: #FF396F;
        background-color: #FF396F;
    }

    .k-state-disabled, .k-disabled, .k-widget[disabled], .k-disabled {
        background: #e9ecef !important;
        opacity: 1;
    }

    .k-window {
        left: 0pxx !important;
        width: 0pxx !important;
        height: 600pxx !important;
        min-width: 120pxx !important;
        min-height: 100pxx !important;
    }

    /*start telerik upload*/

    .k-upload-files {
        max-height: 200px;
        overflow-y: auto;
    }

    .k-form-hint {
        display: block;
        margin-top: 1em;
    }

    .demo-section > .kd-demo-heading {
        padding-bottom: 0;
        margin-bottom: 1em;
    }

    .k-file-success {
        display: none !important;
    }
    /*end  telerik upload*/

    /*start basic upload*/

    .file-input-zone {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: transparent;
        color: black;
        cursor: pointer;
        /*cursor: crosshair;*/
        background: no-repeat;
        position: relative;
        font-weight: bold;
        width: 100px !important;
        height: 30px;
        background-size: 33px 30px;
        background-image: url('/img/attachment-file.svg');
    }

        .file-input-zone input[type=file] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
    /*end  basic upload*/

</style>


@if (!isLoading) {

    <TelerikWindow Class="telerik-pop col-md-6 col-sm-8 col-11 mx-auto" Centered="true"
               Modal="true" @bind-Visible="@isPopupMain">
        <WindowTitle>
            <strong>Info</strong>
        </WindowTitle>
        <WindowActions>
            @*<WindowAction Name="Close" />*@
        </WindowActions>
        <WindowContent>

            @if (!isShowIconSet)
            {
                <div class="row">
                <div class="col-12">
                    <h3>@Caption</h3>
                </div>
            </div>

            <div class="row pt-2">
                <div class="col-md-12">
                    <span>รหัสบอร์ด</span>
                    <TelerikTextBox PlaceHolder="สร้างเอกสาร" @bind-Value="@_boardMasterService.DocSet.head.board_id" Enabled="@false" />
                </div>
            </div>

            <div class="row pt-1">
                <div class="col-12">
                    <span>ชื่อบอร์ด</span>
                    <TelerikTextBox PlaceHolder="" @bind-Value="@_boardMasterService.DocSet.head.description" />
                </div>
            </div>

            <div class="row pt-1">
                <div class="col-12">
                    <span>ลิงค์</span>
                    <TelerikTextArea @bind-Value="@_boardMasterService.DocSet.head.board_url"
                                 AutoSize="true"
                                 Class="w-100"
                                 PlaceHolder="">
                    </TelerikTextArea>
                </div>
            </div>

            <div class="row pt-1">
                <div class="col-12">
                    <span>จัดเรียง</span>
                    <TelerikNumericTextBox Decimals="0" Enabled="true" Format="N0" Max="1000"
                                       Class="text-center font-weight-bold" @bind-Value="Sort"></TelerikNumericTextBox>
                </div>
            </div>

            <div class="row pt-1">
                <div class="col-6">
                    <TelerikCheckBox Id="chkIsActive" @bind-Value="@active"></TelerikCheckBox>
                    <span style="font-size:medium;">ใช้งาน</span>
                </div>
                <div class="col-6 text-end">
                    <TelerikCheckBox Id="chkIsDefault" @bind-Value="@is_default"></TelerikCheckBox>
                    <span style="font-size:medium;">แสดงที่หน้าแรก</span>
                </div>
            </div>


            @if (_boardMasterService.DocSet != null) {
                @if (!string.IsNullOrEmpty(_boardMasterService.DocSet.head.board_id)) {

                    <div class="row pt-3">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="fw-bold">อัพโหลดไฟล์</h5>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="row pt-3">
                                        <div class="col-8">
                                            <div class="file-input-zone">
                                                <InputFile class="upload" OnChange="OnInputFileChanged" style="opacity:0;" accept="image/png, image/jpeg, image/gif">
                                                </InputFile>
                                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>แนบไฟล์</span>
                                            </div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        </div>
                                        <div class="col-4 text-end">
                                            <TelerikButton Size="@(ThemeConstants.Button.Size.Medium)"
                                               @onclick="@BtnSelectIcon" Class="px-3" FillMode="@(ThemeConstants.Button.FillMode.Solid)"
                                               ThemeColor="@(ThemeConstants.Button.ThemeColor.Base)">
                                                <span><i class="fa-solid fa-circle-check"></i>&nbsp;เลือกไอคอน</span>
                                            </TelerikButton>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @if (!isUploading) {
                                @if (_boardMasterService.DocSet.files.Count() > 0) {
                                    <div class="row pt-1">
                                        <div class="col-10 mx-auto mx-0 text-center">
                                            <a @onclick="@(() => DownloadFIle(@_boardMasterService.DocSet.files.FirstOrDefault()))">
                                                <img src=@_boardMasterService.DocSet.vhead.img_path class="img-circle" style="width:8rem;">
                                            </a>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 text-end">
                                            <a class="btn btn-default" @onclick="@(() => OnDeleteFile(@_boardMasterService.DocSet.files.FirstOrDefault()))"> <i class="far fa-trash-alt"></i></a>
                                        </div>
                                    </div>
                                }
                            } else {
                                <div class="loader-container">
                                    <TelerikLoader Class="loader-indicator" Type="@LoaderType.ConvergingSpinner" Size="@(ThemeConstants.Loader.Size.Large)"></TelerikLoader>
                                </div>
                            }
                        </div>
                    </div>
                }
            }

            <div class="row pt-3">
                <div class="col-12 text-end">
                    <TelerikButton Size="@(ThemeConstants.Button.Size.Large)"
                               @onclick="@OnSave" Class="px-4 py-2"
                               ThemeColor="@(ThemeConstants.Button.ThemeColor.Success)">
                        <i class="fa-solid fa-floppy-disk ga-lg"></i>&nbsp; บันทึกข้อมูล
                    </TelerikButton>&nbsp;&nbsp;
                    <TelerikButton Size="@(ThemeConstants.Button.Size.Large)"
                               @onclick="@OnClose"
                               ThemeColor="@(ThemeConstants.Button.ThemeColor.Error)">
                        <i class="fa-solid fa-rectangle-xmark"></i>&nbsp; ปิด
                    </TelerikButton>
                </div>
                </div>
            }else
            {
                <div class="row">
                <div class="col-12">
                    @*@foreach (var l in IconSetList)
                    {
                        <div class="row">
                            <div class="col-md-4 col-sm-6 col-12">
                                <img src="@l.img_path" alt="@l.icon_name" class="w-100" />
                                <div class="text-center">
                                        <h4>@l.icon_name</h4>
                                    </div>
                            </div>
                        </div>
                    }*@
                        <TelerikListView Data=@IconSetList
                                 Height="600px" Pageable="true"
                             PageSize="12">
                            <HeaderTemplate>
                                <div class="row">
                                    <div class="col-6 pt-2">
                                        <div class="d-inline">
                                            คลิ๊ก เลือกไอคอนที่ต้องการ
                                        </div>
                                        <TelerikButton Size="@(ThemeConstants.Button.Size.Small)"
                                               @onclick="@CloseSelectIcon"
                                               ThemeColor="@(ThemeConstants.Button.ThemeColor.Base)">
                                            <i class="fa-solid fa-circle-chevron-left"></i>&nbsp; กลับไปก่อนหน้า
                                        </TelerikButton>
                                    </div>
                                </div>
                            </HeaderTemplate>
                            <Template>
                                <a @onclick="@(() => SelectImage(context))">
                                <div class="gallery">
                                    <div>
                                    <img src="@context.img_path" alt="@context.icon_name" />
                                        <p class="title">@context.icon_name</p>
                                    </div>
                                </div>
                                </a>
                            </Template>
                            <FooterTemplate>
                                <div class="footer-note">ทั้งหมด : @IconSetList.Count().ToString()</div>
                            </FooterTemplate>
                        </TelerikListView>
                    </div>
                </div>
            }
        </WindowContent>
    </TelerikWindow>

    <TelerikDialog @bind-Visible="@dialog_Visible" Class="col-2" ShowCloseButton="false" Title="">
        <DialogContent>
            <div class="text-center">
                @if (Error_dialog == "error") {
                    <i style="color:#f27474;" class="fa-regular fa-circle-xmark fa-3x"></i>
                } else {
                    <i style="color:#37b400;" class="fa-regular fa-circle-check fa-3x"></i>
                }
                <br /><br />
                <span style="text-align: center;">@Caption_dialog</span>
            </div>
        </DialogContent>
        <DialogButtons>
            @*<TelerikButton OnClick="@(() => { dialog_Visible = false; })">No</TelerikButton>*@
            <TelerikButton ThemeColor="@(ThemeConstants.Button.ThemeColor.Success)" OnClick="@ConfirmSave">ตกลง</TelerikButton>
            @*<TelerikButton ThemeColor="@(ThemeConstants.Button.ThemeColor.Success)" OnClick="@(() => { dialog_Visible = false; })">OK</TelerikButton>*@
        </DialogButtons>
    </TelerikDialog>

    <TelerikDialog @bind-Visible="@dialog_images_Visible" Class="col-2" ShowCloseButton="false" Title="">
        <DialogContent>
            <div class="text-center">
                @if (Error_dialog == "error")
                {
                    <i style="color:#f27474;" class="fa-regular fa-circle-xmark fa-3x"></i>
                }
                else
                {
                    <i style="color:#37b400;" class="fa-regular fa-circle-check fa-3x"></i>
                }
                <br /><br />
                <span style="text-align: center;">@Caption_dialog</span>
            </div>
        </DialogContent>
        <DialogButtons>
            <TelerikButton ThemeColor="@(ThemeConstants.Button.ThemeColor.Success)" @onclick="@(() => ConfirmImage())">ตกลง</TelerikButton>
            <TelerikButton OnClick="@(() => { dialog_images_Visible = false; })">ยกเลิก</TelerikButton>
        </DialogButtons>
    </TelerikDialog>

    <div class="col-md-10 col-sm-12 col-12 mx-auto pb-3">
        <div class="row">
            <div class="col-md-6 col-12 pt-2">
                <TelerikButton Size="@(ThemeConstants.Button.Size.Large)"
                           @onclick="@Back" Class="px-3" FillMode="@(ThemeConstants.Button.FillMode.Solid)"
                           ThemeColor="@(ThemeConstants.Button.ThemeColor.Base)">
                    <span style="font-size: medium;"><i class="fa-solid fa-circle-chevron-left"></i>&nbsp;&nbsp;&nbsp;@menuCaption</span>
                </TelerikButton>
            </div>
            <div class="col-md-6 col-12 pt-2 text-end">
                <TelerikButton Size="@(ThemeConstants.Button.Size.Large)"
                           @onclick="@NewDoc" Class="px-3"
                           ThemeColor="@(ThemeConstants.Button.ThemeColor.Primary)">
                    <i class="fa-solid fa-file fa-lg"></i>&nbsp; เพิ่มเมนู Tableau
                </TelerikButton>
            </div>
        </div>

        <div class="row pt-3">
            <div class="col-md-12">
                <TelerikTextBox PlaceHolder="คำค้นหา" FillMode="@(ThemeConstants.TextBox.FillMode.Outline)" ValueChanged="@OnTextChanged_Search"></TelerikTextBox>
            </div>
        </div>

        <div class="row pt-2">
            <div class="col-12">
                <TelerikGrid Data=@DocList
                        @ref="@grd"
                         Pageable="true"
                         Groupable="false"
                         Sortable="true"
                         Resizable="true"
                         Reorderable="true"
                         PageSize="30"
                         Navigable="true"
                         RowDraggable="true"
                         OnRowDrop="@((GridRowDropEventArgs<vw_board_master> args) => ReOrder(args))">
                    <GridColumns>
                        <GridColumn Field="@nameof(vw_board_master.board_id)" Title="แก้ไข" Editable="false" Width="90px">
                            <Template>
                                @{
                                    var data = context as vw_board_master;
                                    <button class="btn btn-sm" @onclick="@(() => Edit(data))"><i class="fa-solid fa-pen-to-square" style="font-size:20px"></i></button>
                                }
                            </Template>
                        </GridColumn>
                        <GridColumn Field="@nameof(vw_board_master.board_id)" Title="รหัสบอร์ด" Width="180px" />
                        <GridColumn Field="@nameof(vw_board_master.description)" Title="ชื่อบอร์ด" Width="200px" />
                        <GridColumn Field="@nameof(vw_board_master.filename)" Title="ชื่อไฟล์" Width="180px" />
                        <GridColumn Field="@nameof(vw_board_master.board_url)" Title="ลิงค์" Width="200px" />
                        <GridColumn Field="@nameof(vw_board_master.sort)" Title="ลำดับ" Width="120px" />
                        @if (isShowDelete) {
                            <GridColumn Title="ลบ" Editable="false" Width="75px">
                                <Template>
                                    @{
                                        var data = context as vw_board_master;
                                        <div class="text-center">
                                            <button class="btn btn-sm" @onclick="@(() => DeleteLine(data))"><i class="fa-solid fa-trash" style="font-size:20px"></i>  </button>
                                        </div>
                                    }
                                </Template>
                            </GridColumn>
                        }
                    </GridColumns>
                </TelerikGrid>
            </div>
        </div>

    </div>

} else {
    <div class="loader-container">
        <TelerikLoader Class="loader-indicator" Type="@LoaderType.ConvergingSpinner" Size="@(ThemeConstants.Loader.Size.Large)"></TelerikLoader>
    </div>
}

@code {

    private bool isLoading = false;
    private bool isUploading = false;
    bool collapse1Visible = true;

    string Caption = "";
    public bool isPopupMain { get; set; } = false;
    public string ImageUrl { get; set; } = "";

    //dialog
    private bool dialog_Visible { get; set; } = false;
    string Caption_dialog = "";
    string Error_dialog = "";

    //dialog image
    private bool dialog_images_Visible { get; set; } = false;
    string iconid = "";
    string fileid = "";

    string menuCaption = "";
    public int Sort { get; set; }
    public bool active { get; set; } = true;
    public bool is_default { get; set; } = false;
    private bool isShowDelete = true;

    private bool isShowIconSet = false;

    string SearchText = "";
    public string Size { get; set; } = ThemeConstants.CheckBox.Size.Medium;

    public TelerikGrid<vw_board_master> grd { get; set; }
    IEnumerable<vw_board_master> DocList;

    IEnumerable<vw_icon_set> IconSetList;

    List<FilesInfo> upload_file = new List<FilesInfo>();
    public TelerikGrid<vw_xfile_ref> TrFileGrid { get; set; }

    protected override async Task OnInitializedAsync() {
        isLoading = true;
        await Task.Run(() => login.CheckLogin());
        await Task.Run(() => CheckIsRefresh());
        await Task.Run(LoadData);
        await Task.Run(LoadGrdBoard);
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    async Task CheckIsRefresh() {
        try {
            if (_boardMasterService.DocSet == null) {
                string docid = await sessionStorage.GetItemAsync<string>(Globals.ActiveID_BoadrID);
                if (!string.IsNullOrEmpty(docid)) {
                    _boardMasterService.DocSet = await _boardMasterService.GetDocSet(docid);
                } else {
                    _boardMasterService.DocSet = BoardMasterService.NewTransaction("standard");
                }
            }
        } catch (Exception ex) {
            var xx = ex.Message;
        }

    }

    protected async Task LoadData() {
        BindData();
        await CheckPermission();
    }

    async Task CheckPermission() {
        var menu = UserService.GetMenuInfo(login.LogInInfo, "437");
        menuCaption = menu.menu_name;
        var Permissionmenu = login.LogInInfo.UserInMenu.Where(o => o.MenuID == "437").FirstOrDefault();
        if (!Convert.ToBoolean(Permissionmenu.IsDelete)) {
            isShowDelete = true;
        }
    }

    async Task LoadGrdBoard() {
        DocList = await _boardMasterService.ListDoc(SearchText);
        DocList = DocList.Where(o => o.board_type == "standard").OrderBy(o => o.sort).ToList();
    }

    async Task SearchAction() {
        await Task.Run(LoadGrdBoard);
    }

    public async void BindData() {
        var h = _boardMasterService.DocSet.head;
        if (!string.IsNullOrEmpty(h.board_id)) {
        } else {
            h.sort = await _boardMasterService.GenSort();
        }

        if (h.is_active == 1) {
            active = true;
        } else {
            active = false;
        }
        if (h.is_default == 1) {
            is_default = true;
        } else {
            is_default = false;
        }

        Sort = h.sort;

        await InvokeAsync(StateHasChanged);
    }


    bool ValidData() {
        var h = _boardMasterService.DocSet.head;
        bool isvalid = true;
        string Errmsg = "";

        //if (boardid == "") {
        //    Errmsg = "!! ระบุ รหัสบอร์ด";
        //    isvalid = false;
        //}

        if (h.description == "") {
            Errmsg = "ระบุ ชื่อบอร์ด";
            isvalid = false;
        }

        if (!isvalid) {
            //Swal.FireAsync("", Errmsg, "error");
            Caption_dialog = Errmsg;
            Error_dialog = "error";
            dialog_Visible = true;
        }
        return isvalid;
    }

    protected async Task<bool> PrepairDataSave() {
        var h = _boardMasterService.DocSet.head;

        bool isnew = h.board_id == "" ? true : false;
        if (isnew)
        {
            if (string.IsNullOrEmpty(h.board_id))
            {
                List<string>? list_docid = await Task.Run(() => _iDRuunerService.GetNewIDV2("TABLEAU", "DPM", "",DateTime.Now.Date, true, "th"));
                h.board_id = list_docid[1];
            }
        }
        if (h.name == "") {
            h.name = h.description;
        }

        h.sort = Sort;
        h.is_active = Convert.ToInt32(active);
        h.is_default = Convert.ToInt32(is_default);

        return isnew;
    }

    public async void OnSave() {
        if (!ValidData()) {
            return;
        }

        var h = _boardMasterService.DocSet.head;
        var isnew = await Task.Run(() => PrepairDataSave());
        string strPayload = JsonSerializer.Serialize(_boardMasterService.DocSet);
        string url = $"api/BoardMaster/SaveBoardMaster?action={isnew}";
        var response = await Http.PostAsJsonAsync(url, strPayload);
        var status = response.StatusCode;
        if (status.ToString().ToLower() != "ok") {
        } else {
            var r = response.Content.ReadFromJsonAsync<I_BasicResult>().Result;
            if (r.Result == "fail") {
                //await Swal.FireAsync("", r.Message1, "error");
                Caption_dialog = r.Message1;
                Error_dialog = "error";
                dialog_Visible = true;
            } else {
                _boardMasterService.DocSet = await _boardMasterService.GetDocSet(h.board_id);
                await sessionStorage.SetItemAsync(Globals.ActiveID_BoadrID, h.board_id);
                if (isnew)
                {
                    var rs = await _logTranService.CreateTransLog(h.board_id,login.LogInInfo.CurrentUser, "จัดการเมนู Tableau", "เพิ่ม จัดการเมนู Tableau");
                }else
                {
                    var rs = await _logTranService.CreateTransLog(h.board_id,login.LogInInfo.CurrentUser, "จัดการเมนู Tableau", "แก้ไข จัดการเมนู Tableau");
                }
                BindData();
                Caption_dialog = "บันทึกข้อมูลสำเร็จ";
                Error_dialog = "success";
                dialog_Visible = true;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    public async void ConfirmSave()
    {
        dialog_Visible = false;
        isPopupMain = false;
        await Task.Run(LoadGrdBoard);
        await InvokeAsync(StateHasChanged);
    }

    // SelectImage
    async void SelectImage(vw_icon_set data) {
        dialog_images_Visible = true;
        iconid = data.icon_id;
        fileid = data.file_id;
        Caption_dialog = "เลือกภาพนี้เพื่ออัพโหลด";
        Error_dialog = "success";
        await InvokeAsync(StateHasChanged);
    }

    public async void ConfirmImage()
    {
        string user = login.LogInInfo.CurrentUser;
        var h = _boardMasterService.DocSet.head;

        var datafile = await Task.Run(() => _filego.GetFileInBytePostgres("DPM","","ICON_CATEGORY",iconid));
        var file = await Task.Run(() => _filego.GetFileIdPostgres("DPM","","ICON_CATEGORY",iconid));

        upload_file = new List<FilesInfo>();
        var nfile = await _filego.NewFilesInfoPostgres("IMAGE_BOARD","DPM","",h.board_id);
        nfile.data = Convert.ToBase64String(datafile.data);
        nfile.file_type = file.filetype;
        nfile.fileName = file.filename;
        upload_file.Add(nfile);

        if (_boardMasterService.DocSet.files.Count() > 0)
        {
            var rr = await Task.Run(async () => _filego.DeleteFileByFileIdPostgres("DPM", "", "IMAGE_BOARD", h.board_id,_boardMasterService.DocSet.files.FirstOrDefault().file_id,user));
        }

        var data = await _filego.SaveToFileGo(upload_file, user);
        _boardMasterService.DocSet = await _boardMasterService.GetDocSet(h.board_id);

        iconid = "";
        fileid = "";
        dialog_images_Visible = false;
        isShowIconSet = false;

        await InvokeAsync(StateHasChanged);
    }

        async Task LoadGrdIconSet() {
        IconSetList = await _iconSetService.ListDoc("");
    }

    async void BtnSelectIcon()
    {
        await Task.Run(LoadGrdIconSet);
        isShowIconSet = true;
        await InvokeAsync(StateHasChanged);
    }

        public async void CloseSelectIcon() {
        isShowIconSet = false;
        await InvokeAsync(StateHasChanged);
    }

    // end SelectImage

    public async void OnClose() {
        isPopupMain = false;
        await Task.Run(LoadGrdBoard);
        await InvokeAsync(StateHasChanged);
    }

    public async void OnTextChanged_Search(object Search) {
        if (Search != null) {
            SearchText = Search.ToString();
            await Task.Run(() => SearchAction());
        }
    }

    async void Edit(vw_board_master data) {
        Caption = "แก้ไขเอกสาร";
        isPopupMain = true;
        _boardMasterService.DocSet = await _boardMasterService.GetDocSet(data.board_id);
        BindData();
        //nav.NavigateTo($"Master/MasterTypeDetail", false);
        await InvokeAsync(StateHasChanged);
    }

    async void DeleteLine(vw_board_master data) {
        SweetAlertResult result = await Swal.FireAsync(new SweetAlertOptions {
                Title = "Warning",
                Text = $"ยืนยันการลบเอกสาร",
                ShowCancelButton = true,
                ConfirmButtonText = "Yes",
                CancelButtonText = "No"
            });
        if (string.IsNullOrEmpty(result.Value)) {
            return;
        }

        var rs = await _boardMasterService.DeleteDoc(data.board_id, login.LogInInfo.CurrentUser);
        var r = await _logTranService.CreateTransLog(data.board_id,login.LogInInfo.CurrentUser, "จัดการเมนู Tableau", "ลบ จัดการเมนู Tableau");
        if (rs.Result == "ok") {
            grd?.Rebind();
        } else {
            await Swal.FireAsync("", rs.Message1, "error");
        }
        await Task.Run(LoadGrdBoard);
        await InvokeAsync(StateHasChanged);
    }

    async Task NewDoc() {
        Caption = "เพิ่มเอกสาร";
        isPopupMain = true;
        await sessionStorage.RemoveItemAsync(Globals.ActiveID_BoadrID);
        _boardMasterService.DocSet = BoardMasterService.NewTransaction("standard");
        await Task.Run(LoadData);
        await InvokeAsync(StateHasChanged);
    }

    async void Back() {
        nav.NavigateTo($"Menu/MenuSIDE/400", false);
        await InvokeAsync(StateHasChanged);
    }

    #region upload file

    public async Task OnInputFileChanged(InputFileChangeEventArgs e) {
        isUploading = true;
        var files = e.GetMultipleFiles(maximumFileCount: 1); // get the files selected by the users
                                                             //var rcom = login.LoginInfo.CurrentRootCompany.CompanyID;
                                                             //var com = login.LoginInfo.CurrentCompany.CompanyID;
                                                             //var docid = itemService.DocSet.Info.ItemID;
        var h = _boardMasterService.DocSet.head;
        if (string.IsNullOrEmpty(h.board_id)) {
            await Swal.FireAsync("Error", "Save before upload", "error");
            return;
        }
        string user = login.LogInInfo.CurrentUser;
        try {
            upload_file = new List<FilesInfo>();
            foreach (var file in e.GetMultipleFiles(1)) {
                using var stream = file.OpenReadStream(maxAllowedSize: (1024 * 1024 * 15));
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);

                var nfile = await _filego.NewFilesInfoPostgres("IMAGE_BOARD", "DPM", "", h.board_id);
                nfile.data = Convert.ToBase64String(ms.ToArray());
                // nfile.data = buf;
                nfile.file_type = file.ContentType;
                nfile.fileName = file.Name;
                upload_file.Add(nfile);
            }

            if (_boardMasterService.DocSet.files.Count() > 0) {
                var rr = await Task.Run(async () => _filego.DeleteFileByFileIdPostgres("DPM", "", "IMAGE_BOARD", h.board_id, _boardMasterService.DocSet.files.FirstOrDefault().file_id, login.LogInInfo.CurrentUser));
            }
            var data = await _filego.SaveToFileGo(upload_file, user);

             _boardMasterService.DocSet = await _boardMasterService.GetDocSet(h.board_id);
            //_boardMasterService.DocSet = await _boardMasterService.GetLatestFiles(_boardMasterService.DocSet);
            //TrFileGrid?.Rebind();
        } catch (Exception ex) {
            await Swal.FireAsync("Error", ex.Message, "error");
        } finally {
            isUploading = false;
        }
    }

    public async void DownloadFIle(vw_xfile_ref data) {
        try {
            var h = _boardMasterService.DocSet.head;
            string file_url = await _filego.GetFileUrlPostgres(data.file_id);
            if (!string.IsNullOrEmpty(file_url)) {
                nav.NavigateTo(file_url, true);
            }
        } catch {
        }
    }

    public async Task OnDeleteFile(vw_xfile_ref data) {
        try {
            var h = _boardMasterService.DocSet.head;
            var rr = await Task.Run(() => _filego.DeleteFileByFileIdPostgres("DPM", "", "IMAGE_BOARD", h.board_id, data.file_id, login.LogInInfo.CurrentUser));
            if (rr.Result == "ok") {
                _boardMasterService.DocSet = await _boardMasterService.GetDocSet(h.board_id);
                BindData();
                Caption_dialog = "ลบภาพสำเร็จ";
                Error_dialog = "success";
                dialog_Visible = true;
                await InvokeAsync(StateHasChanged);
            } else {
                Caption_dialog = rr.Message1;
                Error_dialog = "error";
                dialog_Visible = true;
            }
        } catch {
        } finally {

        }
    }

    #endregion

    private async void ReOrder(GridRowDropEventArgs<vw_board_master> args)
    {
        var new_id = args.Item.board_id;
        var new_sort = args.Item.sort;
        var old_id = args.DestinationItem.board_id;
        var old_sort = args.DestinationItem.sort;

        if (old_sort > new_sort)
        {
            var reNumber_item = DocList.Where(o => o.sort <= old_sort && o.sort > new_sort && o.board_id != new_id).ToList();
            foreach (var i in reNumber_item)
            {
                i.sort = i.sort - 1;
            }
            var get_new = DocList.Where(o => o.board_id == new_id).FirstOrDefault();
            get_new.sort = old_sort;
            //var get_old = ListNewsCateHead.Where(o => o.CateID == old.CateID).FirstOrDefault();
            //get_old.Sort = get_old.Sort - 1;

        }
        else
        {
            var reNumber_item = DocList.Where(o => o.sort >= old_sort && o.sort < new_sort && o.board_id != new_id).ToList();
            foreach (var i in reNumber_item)
            {
                i.sort = i.sort + 1;
            }

            var get_new = DocList.Where(o => o.board_id == new_id).FirstOrDefault();
            get_new.sort = old_sort;
        }

        DocList = DocList.OrderBy(o => o.board_id).ThenBy(o => o.sort).ToList();

        try
        {
            var rs = await Task.Run(()=> _boardMasterService.ReOrder(BoardMasterService.ConvertViewToHead(DocList.ToList())));
        }
        catch (Exception ex)
        {

        }
        await Task.Run(LoadGrdBoard);
        await InvokeAsync(StateHasChanged);
    }

}
