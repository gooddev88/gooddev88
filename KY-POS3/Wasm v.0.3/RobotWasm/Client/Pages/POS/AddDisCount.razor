@page "/POS/AddDisCount"

@using System.Text.Json
@using System.Text
@using RobotWasm.Shared.Data.DA;
@using RobotWasm.Shared.Data.ML.Login;
@using RobotWasm.Shared.Data.ML.Shared
@using Blazorise
@using RobotWasm.Shared.Data.GaDB

<div class="row card-top-menu">
    <a class="p-0 text-decoration-none text-dark" @onclick="@GoBack">
        <div class="text-center">
            <div class="d-inline-block float-start"><i class="fa-solid fa-circle-chevron-left fa-2x"></i></div>
            <div class="d-inline-block"><span class="fw-bold" style="font-size:large;">ส่วนลด</span></div>
        </div>
    </a>
</div>

@if (_posService.DocSet != null) {
<div class="row pt-2">
    <div class="col-md-10 col-sm-10 col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <div class="row pb-2">
                            <div class="col-12">
                                <label>เลือกส่วนลด</label>
                                <TelerikDropDownList @bind-Value="@SelectDisCount"
                                                     Data="@DisCounts"
                                                     TextField="@nameof(SelectOption.Description)"
                                                     ValueField="@nameof(SelectOption.Value)"
                                                     Filterable="true"
                                                     Size="@ThemeConstants.DropDownList.Size.Medium"
                                                     FilterOperator="@StringFilterOperator.Contains"
                                                     Width="100%">
                                </TelerikDropDownList>
                            </div>
                        </div>

                        <div class="row pb-1">
                            <div class="col-12">
                                <label>ใส่จำนวน </label>
                                <TelerikTextBox @bind-Value="@txtqty_discount" Class="text-end pe-2"
                                                Size="@ThemeConstants.DropDownList.Size.Medium" />
                            </div>
                        </div>

                        <div class="row pt-3">
                            <div class="col-12">
                                    <TelerikButton Class="w-100" ThemeColor="@(ThemeConstants.Button.ThemeColor.Info)" @onclick="@OnAddDisCount"
                                               Size="@(ThemeConstants.Button.Size.Large)">
                                    ตกลง
                                </TelerikButton>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
}

<div>
    <TelerikLoaderContainer Size="@ThemeConstants.Loader.Size.Large"
                            Text="ระบบกำลังประมวลผล ....."
                            Visible="@isLoading"
                            LoaderPosition="@LoaderPosition.End"></TelerikLoaderContainer>
</div>

@code {
    bool isLoading = false;

    public string SelectDisCount { get; set; } = "DISCPER01";
    public string txtqty_discount { get; set; } = "0";

    List<SelectOption> DisCounts = new List<SelectOption>();

    protected override async Task OnInitializedAsync() {
        isLoading = true;
        await Task.Run(() => login.CheckLogin());
        await Task.Run(() => CheckIsRefresh());
        await Task.Run(LoadData);
        await InvokeAsync(StateHasChanged);
    }

    async Task CheckIsRefresh() {
        if (_posService.DocSet == null) {
            var docid = await sessionStorage.GetItemAsync<string>(Globals.SessionActive_PosID);
            string rcom = await _localStorage.GetItemAsync<string>(Globals.localStorageRcomID) ?? "";
            if (!string.IsNullOrEmpty(docid)) {
                _posService.DocSet = await Task.Run(() => _posService.GetDocSet(docid, rcom));
            } else {
                nav.NavigateTo("POS/POSSaleDetail");
                await InvokeAsync(StateHasChanged);
                return;
            }

            if (_posService.Menu.Count() == 0) {
                _posService.Menu = await Task.Run(() => _posService.ListMenuItem(_posService.DocSet.Head.RComID, _posService.DocSet.Head.ComID, _posService.DocSet.Head.ShipToUsePrice));
            } else {
                foreach (var l in _posService.DocSet.Line) {
                    if (_posService.Menu != null) {
                        var iInfo = _posService.Menu.Where(o => o.ItemID == l.ItemID).FirstOrDefault();
                        if (iInfo != null) {
                            l.ImageUrl = iInfo.ImageUrl;
                            l.ImageSource = iInfo.ImageUrl;
                        }
                    }
                }
            }

            if (_posService.ItemCate.Count() == 0) {
                _posService.ItemCate = await Task.Run(() => _posService.ListItemCate(_posService.DocSet.Head.RComID));
            }

            if (_posService.Tenders.Count() == 0) {
                _posService.Tenders = ListTenderType();
            }
        }
    }

    async void LoadData() {
        DisCounts = POSFuncService.ListDisCount();
        isLoading = false;
        await InvokeAsync(StateHasChanged);
    }

    async void OnAddDisCount() {
        decimal disc = 0;
        decimal.TryParse(txtqty_discount, out disc);

        if (disc == 0) {
            await Swal.FireAsync("Warning", "ระบุส่วนลด", "info");
            return;
        }

        isLoading = true;

        _posService.DocSet.SelectItem = _posService.Menu.Where(o => o.ItemID == SelectDisCount).FirstOrDefault();
        _posService.DocSet.SelectItem.ImageUrl = "img/discount.png";
        _posService.DocSet = POSFuncService.AddItem(_posService.DocSet,1, disc);
        _posService.DocSet.LineActive.ImageUrl = "img/discount.png";
        isLoading = false;
        nav.NavigateTo("POS/POSSaleDetail");
        await InvokeAsync(StateHasChanged);
    }

    void GoBack() {
        nav.NavigateTo("POS/POSSaleDetail");
    }
}
